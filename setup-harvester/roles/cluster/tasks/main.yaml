---
- name: Create temporary directory for license files on remote node
  ansible.builtin.file:
    path: /tmp/helm-licenses
    state: directory
    mode: '0755'
#  run_once: true

- name: Copy KubeDB license file to remote node
  ansible.builtin.copy:
    src: ~/Downloads/kubedb-license-{{ license_ids[inventory_hostname].kubedb_license_id }}.txt
    dest: /tmp/helm-licenses/kubedb-license.txt
    mode: '0644'
#  run_once: true

- name: Check and install Helm if not present
  ansible.builtin.shell: |
    if ! command -v helm >/dev/null 2>&1; then
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Add Helm repositories
  ansible.builtin.command: |
    helm repo add {{ item.name }} {{ item.url }}
  loop:
    - { name: longhorn, url: https://charts.longhorn.io }
    - { name: appscode, url: https://charts.appscode.com/stable/ }
    - { name: prometheus-community, url: https://prometheus-community.github.io/helm-charts }
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install KubeDB Helm chart
  ansible.builtin.command: |
    helm upgrade -i kubedb oci://ghcr.io/appscode-charts/kubedb \
      --version {{ helm_charts.kubedb.version }} \
      --namespace kubedb --create-namespace \
      --set-file global.license=/tmp/helm-licenses/kubedb-license.txt \
      --wait --burst-limit=10000 --debug
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install KubeStash Helm chart
  ansible.builtin.command: |
    helm upgrade -i kubestash oci://ghcr.io/appscode-charts/kubestash \
      --version {{ helm_charts.kubestash.version }} \
      --namespace stash --create-namespace \
      --set-file global.license=/tmp/helm-licenses/kubedb-license.txt \
      --wait --burst-limit=10000 --debug
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install Longhorn Helm chart
  ansible.builtin.command: |
    helm upgrade -i longhorn longhorn/longhorn \
      --namespace longhorn-system --create-namespace \
      --version {{ helm_charts.longhorn.version }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install KubeDB Metrics Helm chart
  ansible.builtin.command: |
    helm upgrade -i kubedb-metrics appscode/kubedb-metrics \
      --namespace kubedb --create-namespace \
      --version {{ helm_charts.kubedb_metrics.version }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install Kube Prometheus Stack Helm chart
  ansible.builtin.command: |
    helm upgrade -i prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring --create-namespace \
      --set grafana.image.tag=7.5.5
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Install Panopticon Helm chart
  ansible.builtin.command: |
    helm upgrade -i panopticon appscode/panopticon \
      --namespace kubeops --create-namespace \
      --version {{ helm_charts.panopticon.version }} \
      --set monitoring.enabled=true \
      --set monitoring.agent=prometheus.io/operator \
      --set monitoring.serviceMonitor.labels.release=prometheus \
      --set-file global.license=/tmp/helm-licenses/kubedb-license.txt
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin:/usr/bin"
  changed_when: true
#  run_once: true

- name: Remove temporary license directory
  ansible.builtin.file:
    path: /tmp/helm-licenses
    state: absent
#  run_once: true